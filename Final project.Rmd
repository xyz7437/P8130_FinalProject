---
title: "Final Project"
author: "Yijia Jiang"
date: "11/16/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Purpose
We will be analyzing data from the "County Demographic Information" (CDI) data set, which contains characteristics of 440 counties in the United States collected from 1990-1992. The primary objective of this investigation is to develop insight relevant to predicting the crime rate in counties, namely to summarize as the crime rate per 1,000 population (CRM_1000). 


# Import the package we need
```{r include = FALSE}
library(tidyverse)
library(usmap)
library(ggplot2)
library(corrplot)
library(EnvStats)
library(leaps)
library(caret)
library(car)
library(MASS) # boxcox
library(performance) # vif
library(GGally)
library(modelr)
```



# Data preprocessing
## Transfer population variables to per capita variables
```{r}
rm(list = ls())
cdi = read.csv("./data/cdi.csv") %>%
  mutate(crime_rate = crimes/pop, 
         pcarea = area/pop,
         pcdocs = docs/pop,
         pcbeds = beds/pop,
         region = relevel(factor(region),ref = 3))
cdi_pc = cdi %>% 
  dplyr::select(crime_rate, everything(), -id, -cty, -state, -area, -docs, -beds, -crimes, -pop, -totalinc)
summary(cdi_pc)
```


# Exploratory Data Analysis
## Rank of the crime rate by state
```{r}
cdi_state <- cdi %>%
  group_by(state) %>%
  summarize(crime_rate = mean(crime_rate))
#cdi_state_rank <- cdi_state[order(-rank(cdi_state$crime_rate)),]

ggplot(cdi_state,aes(x=reorder(state,crime_rate),y=crime_rate,fill=crime_rate)) + 
  geom_bar(stat ='identity')+
  coord_flip() + 
  theme_grey() + 
  labs(title = 'Ranking of States by crime rate',
       y='Crime rate',x='States') +
  geom_hline(yintercept = mean(cdi$crime_rate),color = "#C9592E")+
  theme(plot.title = element_text(hjust = 0.5,size = 14, face = "bold"),
        axis.text=element_text(size=6.5))
```


## US crime rate map by state
```{r}
p<-plot_usmap(data = cdi_state, values = "crime_rate", color = "#C9592E", size = 0.5,
              labels = TRUE, label_color = "grey10") + 
   scale_fill_continuous(low = "white", high = "#C9592E", na.value = "grey90",
                         name = "Crime rate", label = scales::comma) + 
   theme(legend.position = "right") + 
   theme(panel.background = element_rect(colour = "black")) + 
   labs(title = "US Crime Rate Map") +
   theme(plot.title = element_text(hjust = 0.5,size = 14, face = "bold"))
p$layers[[2]]$aes_params$size <- 2.8
print(p)
```


## Boxplot for each variable
```{r}
par(mfrow=c(3,4))
boxplot(cdi_pc$crime_rate,  main = "crime_rate")
boxplot(cdi_pc$pop18, main = "pop18")
boxplot(cdi_pc$pop65, main = "pop65")
boxplot(cdi_pc$pcincome, main = "pcincome")
boxplot(cdi_pc$unemp,main = "unemp")
boxplot(cdi_pc$hsgrad, main = "hsgrad")
boxplot(cdi_pc$bagrad, main = "bagrad")
boxplot(cdi_pc$poverty, main = "poverty")
boxplot(cdi_pc$pcarea, main = "pcarea")
boxplot(cdi_pc$pcdocs, main = "pcdocs")
boxplot(cdi_pc$pcbeds, main = "pcbeds")
boxplot(crime_rate ~ region, data = cdi_pc, main = "region")
```


## Scatterplot Matrix
```{r}
pairs(~crime_rate +.,data=cdi_pc, panel = panel.smooth, upper.panel = NULL, main = "Scatterplot Matrix")
```


## Correlation plot/ Heatmap
```{r}
cdi_pc %>%
  dplyr::select(-region) %>%
  ggcorr(label = TRUE, hjust = 0.9, layout.exp = 2, label_size = 3, label_round = 2)
```


# Modelling
## Fit regression using all predictors
```{r}
mult_fit = lm(crime_rate ~ ., data = cdi_pc)
summary(mult_fit)
```

## Backwards Elimination
```{r}
mult_fit_back <- step(mult_fit, direction='backward')
mult_fit_back
```
crime_rate ~ pop18 + bagrad + poverty + pcincome + region + pcarea + pcbeds


# Model Diagnostics
## Create Residuals vs Fitted plot & Normal Q-Q plot & Scale-Location plot & Residuals vs Leverage plot to detect the normality of residuals and outliers
```{r}
par(mfrow=c(2,3))
plot(mult_fit_back)
plot(mult_fit_back, which = 4)
bc = boxcox(mult_fit_back)
```


## Checking to Outliers and Influential Points
```{r}
# remove influential points
cdi_pc_out = cdi_pc[-c(6,128,412),]

# fit model with and without influential points
mult_fit_back_without = lm(crime_rate ~ pop18 + bagrad + poverty + pcincome + region + pcarea + pcbeds, data = cdi_pc_out)

summary(mult_fit_back); summary(mult_fit_back_without)

# diagnose the model without outliers
par(mfrow=c(2,3))
plot(mult_fit_back_without)
bc_without = boxcox(mult_fit_back_without)
plot(mult_fit_back_without, which = 4)
```

## Box-cox transformation
```{r}
(lambda = bc_without$x[which.max(bc_without$y)])
#mult_fit_back_without_trans = lm(((crime_rate^lambda-1)/lambda) ~ pop18 + bagrad + poverty + pcincome + region + pcarea + pcbeds, data = cdi_pc_out)

mult_fit_back_without_trans = lm(crime_rate^0.5 ~ pop18 + bagrad + poverty + pcincome + region + pcarea + pcbeds, data = cdi_pc_out)


par(mfrow = c(1,2))
plot(mult_fit_back_without_trans, which = 2) 
boxcox(mult_fit_back_without_trans)

par(mfrow = c(2,3))
plot(mult_fit_back_without_trans)
plot(mult_fit_back_without_trans, which = 4)
bc_without_trans = boxcox(mult_fit_back_without_trans)


par(mfrow = c(1,2))
plot(mult_fit_back_without, which = 2)
plot(mult_fit_back_without_trans, which = 2)
```

## Compare the Adjusted R^2
```{r}
rbind(mult_fit_back %>% broom::glance() %>% mutate(model_type = "mult_fit_back"),
      mult_fit_back_without %>% broom::glance() %>% mutate(model_type = "mult_fit_back_without"),
      mult_fit_back_without_trans %>% broom::glance()%>% mutate(model_type = "mult_fit_back_without_trans")) %>%
        dplyr::select(model_type, everything())
```


## Assessing Multicollinearity
```{r}
# Calculate the variance inflation factor (VIF)
check_collinearity(mult_fit_back_without)

# Remove the variable whose vif is larger than 10 
mult_fit_back_without_vif = lm(crime_rate ~ pop18 + bagrad + pcincome + region + pcarea + pcbeds, data = cdi_pc_out)
mult_fit_back_without_vif 

# Add the interaction 
mult_fit_back_without_int = lm(crime_rate ~ pop18 + bagrad + pcincome + region + pcarea + pcbeds + poverty + pcincome*poverty + pcincome*bagrad + pop18*bagrad, data = cdi_pc_out)
mult_fit_back_without_int
```

## Compare the Adjusted R^2
```{r}
rbind(mult_fit_back %>% broom::glance() %>% mutate(model_type = "mult_fit_back"),
      mult_fit_back_without %>% broom::glance() %>% mutate(model_type = "mult_fit_back_without"),
      mult_fit_back_without_trans %>% broom::glance()%>% mutate(model_type = "mult_fit_back_without_trans"),
      mult_fit_back_without_vif %>% broom::glance() %>% mutate(model_type = "mult_fit_back_without_vif"), 
      mult_fit_back_without_int %>% broom::glance() %>% mutate(model_type = "mult_fit_back_without_int")) %>%
      dplyr::select(model_type, everything())
```



# Validation
## Compute MSE by cross-validation
```{r}
cv_df = 
  crossv_mc(cdi_pc_out, 100) %>% 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble)) %>%
  mutate(
    mult_fit_back_without = map(train, ~lm(crime_rate ~ pop18 + bagrad + poverty + 
                                pcincome + region + pcarea + pcbeds, data = .x)),
    mult_fit_back_without_trans = map(train, ~lm(sqrt(crime_rate) ~ pop18 + bagrad + poverty + 
                                      pcincome + region + pcarea + pcbeds, data = .x)),
    mult_fit_back_without_vif = map(train, ~lm(crime_rate ~ pop18 + bagrad + 
                                    pcincome + region + pcarea + pcbeds, data = .x)),
    mult_fit_back_without_int = map(train, ~lm(crime_rate ~ pop18 + bagrad + pcincome + region + pcarea + pcbeds + poverty +
                                               pcincome*poverty + pcincome*bagrad + pop18*bagrad, data = .x))) %>% 
  mutate(
    rmse_mod1 = map2_dbl(mult_fit_back_without, test, ~rmse(model = .x)),
    rmse_mod2 = map2_dbl(mult_fit_back_without_trans, test, ~rmse(model = .x)),
    rmse_mod3 = map2_dbl(mult_fit_back_without_vif, test, ~rmse(model = .x)),
    rmse_mod4 = map2_dbl(mult_fit_back_without_int, test, ~rmse(model = .x))
  )

cv_df %>% 
  dplyr::select(starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") %>% 
  mutate(model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse)) + geom_violin()
```





