---
title: "Final Project"
author: "Yijia Jiang"
date: "11/16/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Purpose
We will be analyzing data from the "County Demographic Information" (CDI) data set, which contains characteristics of 440 counties in the United States collected from 1990-1992. The primary objective of this investigation is to develop insight relevant to predicting the crime rate in counties, namely to summarize as the crime rate per 1,000 population (CRM_1000). 


## Import the package we need
```{r include = FALSE}
library(tidyverse)
library(usmap)
library(ggplot2)
library(corrplot)
library(EnvStats)
library(leaps)
library(caret)
library(car)
library(MASS) # boxcox
library(performance) # vif
library(GGally)
```



## Data preprocessing
```{r}
rm(list = ls())
cdi = read.csv("./data/cdi.csv") %>%
  mutate(crime_rate = crimes/pop, 
         pcarea = area/pop,
         pcdocs = docs/pop,
         pcbeds = beds/pop,
         region = relevel(factor(region),ref = 3))
cdi_new = cdi %>% 
  dplyr::select(crime_rate, everything(), -id, -cty, -state, -area, -docs, -beds, -crimes, -pop, -totalinc)
summary(cdi_new)
```



## Rank of the crime rate by state
```{r}
cdi_state <- cdi %>%
  group_by(state) %>%
  summarize(crime_rate = mean(crime_rate))
cdi_state_new <- cdi_state[order(-rank(cdi_state$crime_rate)),]

ggplot(cdi_state,aes(x=reorder(state,crime_rate),y=crime_rate,fill=crime_rate)) + 
  geom_bar(stat ='identity')+
  coord_flip() + 
  theme_grey() + 
  labs(title = 'Ranking of Counties by crime rate',
       y='Crime rate',x='Counties') +
  geom_hline(yintercept = mean(cdi$crime_rate),color = "#C9592E")+
  theme(plot.title = element_text(hjust = 0.5,size = 14, face = "bold"),
        axis.text=element_text(size=6.5))
```


## US crime rate map by state
```{r}
p<-plot_usmap(data = cdi_state, values = "crime_rate", color = "#C9592E", size = 0.5,
              labels = TRUE, label_color = "grey10") + 
   scale_fill_continuous(low = "white", high = "#C9592E", na.value = "grey90",
                         name = "Crime rate", label = scales::comma) + 
   theme(legend.position = "right") + 
   theme(panel.background = element_rect(colour = "black")) + 
   labs(title = "US Crime Rate Map") +
   theme(plot.title = element_text(hjust = 0.5,size = 14, face = "bold"))
p$layers[[2]]$aes_params$size <- 2.8
print(p)
```


## Exploratory Data Analysis
```{r}
# Boxplots for each variable
par(mfrow=c(3,4))
boxplot(cdi_new$crime_rate, main='crime_rate')
boxplot(cdi_new$pop18, main='pop18')
boxplot(cdi_new$pop65, main='pop65')
boxplot(cdi_new$pcincome, main='pcincome')
boxplot(cdi_new$unemp,main='unemp')
boxplot(cdi_new$hsgrad, main='hsgrad')
boxplot(cdi_new$bagrad, main='bagrad')
boxplot(cdi_new$poverty, main='poverty')
boxplot(cdi_new$pcarea, main='pcarea')
boxplot(cdi_new$pcdocs, main='pcdocs')
boxplot(cdi_new$pcbeds, main='pcbeds')

# Crime rate by region
boxplot(crime_rate ~ region, data = cdi_new)

# Boxplot for transforming pcarea, looks more normal
cdi_new %>%
  mutate(lnpcarea = log(pcarea)) %>%
  ggplot(aes(y = lnpcarea)) + 
  geom_boxplot()

# Scatterplot Matrix
#plot(x=cdi$area,y=cdi$crime_rate)
#plot(x=cdi$pcincome,y=cdi$crime_rate)
#plot(x=cdi$unemp,y=cdi$crime_rate)
#plot(x=cdi$hsgrad,y=cdi$crime_rate)
#plot(x=cdi$poverty,y=cdi$crime_rate)
# pairs(~crime_rate + pcarea + pop18 + pop65 + pcdocs + pcbeds + hsgrad + bagrad + poverty + unemp + pcincome +      factor(region), data = cdi_new, panel = panel.smooth, upper.panel = NULL, main = "Scatterplot Matrix")
pairs(~crime_rate +.,data=cdi_new,panel = panel.smooth, upper.panel = NULL, main = "Scatterplot Matrix")
```


```{r}
# remove outliers
remove_outliers <- function(x, na.rm = TRUE, ...) {
  qnt <- quantile(x, probs=c(.25, .75), na.rm = na.rm, ...)
  H <- 1.5 * IQR(x, na.rm = na.rm)
  y <- x
  y[x < (qnt[1] - H)] <- NA
  y[x > (qnt[2] + H)] <- NA
  y
}

crime_rate_no_outliers = remove_outliers(cdi_new$crime_rate)
pop18_no_outliers = remove_outliers(cdi_new$pop18)
pop65_no_outliers = remove_outliers(cdi_new$pop65)
hsgrad_no_outliers = remove_outliers(cdi_new$hsgrad)
bagrad_no_outliers = remove_outliers(cdi_new$bagrad)
poverty_no_outliers = remove_outliers(cdi_new$poverty)
unemp_no_outliers = remove_outliers(cdi_new$unemp)
pcincome_no_outliers = remove_outliers(cdi_new$pcincome)
pcarea_no_outliers = remove_outliers(cdi_new$pcarea)
pcdocs_no_outliers = remove_outliers(cdi_new$pcdocs)
pcbeds_no_outliers = remove_outliers(cdi_new$pcbeds)

cdi_no_outliers = cbind.data.frame(crime_rate_no_outliers, pop18_no_outliers, pop65_no_outliers, hsgrad_no_outliers, bagrad_no_outliers, poverty_no_outliers, unemp_no_outliers, pcincome_no_outliers, pcarea_no_outliers, pcdocs_no_outliers, pcbeds_no_outliers, cdi_new$region) %>%
  drop_na() %>%
  rename(region = "cdi_new$region")
```


```{r}
# Correlation plot
ggcorr(cdi_new, label = TRUE, hjust = 0.9, layout.exp = 2, label_size = 3)
ggcorr(cdi_no_outliers, label = TRUE, hjust = 0.9, layout.exp = 2, label_size = 3)
```

## Assess the normality of the data
```{r}
shapiro.test(cdi_no_outliers$crime_rate_no_outliers)
shapiro.test(cdi_no_outliers$pop18_no_outliers)
shapiro.test(cdi_no_outliers$pop65_no_outliers)
shapiro.test(cdi_no_outliers$pcincome_no_outliers)
shapiro.test(cdi_no_outliers$unemp_no_outliers)
shapiro.test(cdi_no_outliers$hsgrad_no_outliers)
shapiro.test(cdi_no_outliers$bagrad_no_outliers)
shapiro.test(cdi_no_outliers$poverty_no_outliers)
shapiro.test(cdi_no_outliers$pcarea_no_outliers)
shapiro.test(cdi_no_outliers$pcdocs_no_outliers)
shapiro.test(cdi_no_outliers$pcbeds_no_outliers)
```


```{r}
# qqplot
qqnorm(cdi_no_outliers$pcbeds_no_outliers, pch = 1, frame = FALSE)
qqline(cdi_no_outliers$pcbeds_no_outliers, col = "steelblue", lwd = 2)

qqnorm(cdi_no_outliers$crime_rate_no_outliers, pch = 1, frame = FALSE)
qqline(cdi_no_outliers$crime_rate_no_outliers, col = "steelblue", lwd = 2)

qqnorm(cdi_new$crime_rate, pch = 1, frame = FALSE)
qqline(cdi_new$crime_rate, col = "steelblue", lwd = 2)
```

According to the Shapiro-Wilk normality test, all the data are normally distributed.


## Detect the outliers
```{r}
rosnerTest(cdi_new$crime_rate,k = 3)$all.stats
```


## Modelling
```{r}
# fit regression using all predictors
mult.fit = lm(crime_rate ~ ., data = cdi_new)
summary(mult.fit)
```



## Backwards Elimination
```{r}
mult.fit.back <- step(mult.fit, direction='backward')
mult.fit.back
```
crime_rate ~ pop18 + bagrad + poverty + pcincome + region + pcarea + pcbeds





## Criterion Based Procedures
```{r}
mat = as.matrix(cdi_new)
# Printing the 2 best models of each size, using the Cp criterion:
leaps(x = mat[,1:12], y = mat[,13], nbest = 2, method = "Cp")

# Printing the 2 best models of each size, using the adjusted R^2 criterion:
leaps(x = mat[,1:12], y = mat[,13], nbest = 2, method = "adjr2")

# Function regsubsets() performs a subset selection by identifying the "best" model that contains
# a certain number of predictors. By default "best" is chosen using SSE/RSS (smaller is better)
b = regsubsets(Lnsurvival ~ ., data = cdi_new)
rs = summary(b)

# plot of Cp and Adj-R2 as functions of parameters
par(mfrow=c(1,2))

plot(2:9, rs$cp, xlab="No of parameters", ylab="Cp Statistic")
abline(0,1)
```



## Validation
```{r}
set.seed(123)
# Use 5-fold validation and create the training sets
train = trainControl(method = "cv", number = 5)

# Fit the 4-variables model that we discussed in previous lectures
model_caret = train(crime_rate ~ pop18 + bagrad + poverty + 
                    pcincome + region + pcarea + pcbeds,
                    data = cdi_new,
                    trControl = train,
                    method = 'lm',
                    na.action = na.pass)

model_caret$finalModel
```



## Model Diagnostics
```{r}
par(mfrow=c(3,2))
plot(mult.fit.back)
bc = boxcox(mult.fit.back)
durbinWatsonTest(mult.fit.back)
```


## Checking to Outliers and Influential Points
```{r}
# Cook's distance
plot(mult.fit.back, which = 4)

# remove influential points
cdi_new_out = cdi_new[-c(6,128,412),]

# plot with and without influential points
par(mfrow=c(1,2))
plot(cdi_new$pop18, cdi_new$crime_rate)
plot(cdi_new_out$pop18, cdi_new_out$crime_rate)

# fit model with and without influential points
with = lm(crime_rate ~ pop18 + bagrad + poverty + pcincome + region + pcarea + pcbeds, data = cdi_new)
without = lm(crime_rate ~ pop18 + bagrad + poverty + pcincome + region + pcarea + pcbeds, data = cdi_new_out)

summary(with); summary(without)

# check without diagnostics
par(mfrow=c(3,2))
plot(without)
bc_without = boxcox(without)
```

```{r}
# test normality
(lambda <- bc$x[which.max(bc$y)])
new_model <- lm(((crime_rate^lambda-1)/lambda) ~ pop18 + bagrad + poverty + pcincome + region + pcarea + pcbeds, data = cdi_new)

par(mfrow=c(3,2))
plot(new_model, which = 2)
boxcox(new_model)

(lambda2 <- bc_without$x[which.max(bc_without$y)])
new_model2 <- lm(((crime_rate^lambda2-1)/lambda2) ~ pop18 + bagrad + poverty + pcincome + region + pcarea + pcbeds, data = cdi_new_out)

par(mfrow=c(2,2))
plot(new_model2, which = 2)
plot(with, which = 2)
plot(new_model, which = 2)
```

```{r}
# find r^2
rbind(new_model %>% broom::glance() %>% mutate(model_type = "new_model"),
      new_model2 %>% broom::glance() %>% mutate(model_type = "new_model2"),
      with %>% broom::glance()%>% mutate(model_type = "with"),
      without %>% broom::glance()%>% mutate(model_type = "without")) %>%
        dplyr::select(model_type, everything())
```


## Assessing Multicollinearity
```{r}
# Calculate the variance inflation factor (VIF)
check_collinearity(mult.fit.back)
```



