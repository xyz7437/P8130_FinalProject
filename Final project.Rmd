---
title: "Final Project"
author: "Yijia Jiang"
date: "11/16/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Purpose
We will be analyzing data from the "County Demographic Information" (CDI) data set, which contains characteristics of 440 counties in the United States collected from 1990-1992. The primary objective of this investigation is to develop insight relevant to predicting the crime rate in counties, namely to summarize as the crime rate per 1,000 population (CRM_1000). 


# Import the package we need
```{r include = FALSE}
library(tidyverse)
library(usmap)
library(ggplot2)
library(corrplot)
library(EnvStats)
library(leaps)
library(caret)
library(car)
library(MASS) # boxcox
library(performance) # vif
library(GGally)
```



# Data preprocessing
## Transfer population variables to per capita variables
```{r}
rm(list = ls())
cdi = read.csv("./data/cdi.csv") %>%
  mutate(crime_rate = crimes/pop, 
         pcarea = area/pop,
         pcdocs = docs/pop,
         pcbeds = beds/pop,
         region = relevel(factor(region),ref = 3))
cdi_pc = cdi %>% 
  dplyr::select(crime_rate, everything(), -id, -cty, -state, -area, -docs, -beds, -crimes, -pop, -totalinc)
summary(cdi_pc)
```


# Exploratory Data Analysis
## Rank of the crime rate by state
```{r}
cdi_state <- cdi %>%
  group_by(state) %>%
  summarize(crime_rate = mean(crime_rate))
#cdi_state_rank <- cdi_state[order(-rank(cdi_state$crime_rate)),]

ggplot(cdi_state,aes(x=reorder(state,crime_rate),y=crime_rate,fill=crime_rate)) + 
  geom_bar(stat ='identity')+
  coord_flip() + 
  theme_grey() + 
  labs(title = 'Ranking of Counties by crime rate',
       y='Crime rate',x='Counties') +
  geom_hline(yintercept = mean(cdi$crime_rate),color = "#C9592E")+
  theme(plot.title = element_text(hjust = 0.5,size = 14, face = "bold"),
        axis.text=element_text(size=6.5))
```


## US crime rate map by state
```{r}
p<-plot_usmap(data = cdi_state, values = "crime_rate", color = "#C9592E", size = 0.5,
              labels = TRUE, label_color = "grey10") + 
   scale_fill_continuous(low = "white", high = "#C9592E", na.value = "grey90",
                         name = "Crime rate", label = scales::comma) + 
   theme(legend.position = "right") + 
   theme(panel.background = element_rect(colour = "black")) + 
   labs(title = "US Crime Rate Map") +
   theme(plot.title = element_text(hjust = 0.5,size = 14, face = "bold"))
p$layers[[2]]$aes_params$size <- 2.8
print(p)
```


## Boxplot for each variable
```{r}
par(mfrow=c(3,4))
boxplot(cdi_pc$crime_rate, main = "crime_rate")
boxplot(cdi_pc$pop18, main = "pop18")
boxplot(cdi_pc$pop65, main = "pop65")
boxplot(cdi_pc$pcincome, main = "pcincome")
boxplot(cdi_pc$unemp,main = "unemp")
boxplot(cdi_pc$hsgrad, main = "hsgrad")
boxplot(cdi_pc$bagrad, main = "bagrad")
boxplot(cdi_pc$poverty, main = "poverty")
boxplot(cdi_pc$pcarea, main = "pcarea")
boxplot(cdi_pc$pcdocs, main = "pcdocs")
boxplot(cdi_pc$pcbeds, main = "pcbeds")
boxplot(crime_rate ~ region, data = cdi_pc, main = "region")
```


## Scatterplot Matrix
```{r}
pairs(~crime_rate +.,data=cdi_pc, panel = panel.smooth, upper.panel = NULL, main = "Scatterplot Matrix")
```


## Correlation plot/ Heatmap
```{r}
ggcorr(cdi_pc, label = TRUE, hjust = 0.9, layout.exp = 2, label_size = 3)
```


##
```{r}
# qqplot
qqnorm(cdi_pc$pcbeds, pch = 1, frame = FALSE)
qqline(cdi_pc$pcbed, col = "steelblue", lwd = 2)

qqnorm(cdi_pc$crime_rate, pch = 1, frame = FALSE)
qqline(cdi_pc$crime_rate, col = "steelblue", lwd = 2)


```

According to the Shapiro-Wilk normality test, all the data are normally distributed.


## Detect the outliers
```{r}
rosnerTest(cdi_pc$crime_rate,k = 3)$all.stats
```


# Modelling
## Fit regression using all predictors
```{r}
mult_fit = lm(crime_rate ~ ., data = cdi_pc)
summary(mult_fit)
```

## Backwards Elimination
```{r}
mult_fit_back <- step(mult_fit, direction='backward')
mult_fit_back
```
crime_rate ~ pop18 + bagrad + poverty + pcincome + region + pcarea + pcbeds


# Model Diagnostics
## Create Residuals vs Fitted plot & Normal Q-Q plot & Scale-Location plot & Residuals vs Leverage plot to detect the normality of residuals and outliers
```{r}
par(mfrow=c(2,3))
plot(mult_fit_back)
bc = boxcox(mult_fit_back)
durbinWatsonTest(mult_fit_back)
plot(mult_fit_back, which = 4)
```


## Checking to Outliers and Influential Points
```{r}
# remove influential points
cdi_pc_out = cdi_pc[-c(6,128,412),]

# fit model with and without influential points
mult_fit_back_without = lm(crime_rate ~ pop18 + bagrad + poverty + pcincome + region + pcarea + pcbeds, data = cdi_pc_out)

summary(mult_fit_back); summary(mult_fit_back_without)

# diagnose the model without outliers
par(mfrow=c(2,3))
plot(mult_fit_back_without)
bc_without = boxcox(mult_fit_back_without)
plot(mult_fit_back_without, which = 4)
```

## Box-cox transformation
```{r}
(lambda = bc_without$x[which.max(bc_without$y)])
#mult_fit_back_without_trans = lm(((crime_rate^lambda-1)/lambda) ~ pop18 + bagrad + poverty + pcincome + region + pcarea + pcbeds, data = cdi_pc_out)

mult_fit_back_without_trans = lm(crime_rate^0.5 ~ pop18 + bagrad + poverty + pcincome + region + pcarea + pcbeds, data = cdi_pc_out)


par(mfrow = c(1,2))
plot(mult_fit_back_without_trans, which = 2) 
boxcox(mult_fit_back_without_trans)

par(mfrow = c(2,3))
plot(mult_fit_back_without_trans)
bc_without_trans = boxcox(mult_fit_back_without_trans)
plot(mult_fit_back_without_trans, which = 4)

par(mfrow = c(1,2))
plot(mult_fit_back_without, which = 2)
plot(mult_fit_back_without_trans, which = 2)
```

## Compare the Adjusted R^2
```{r}
rbind(mult_fit_back %>% broom::glance() %>% mutate(model_type = "mult_fit_back"),
      mult_fit_back_without %>% broom::glance() %>% mutate(model_type = "mult_fit_back_without"),
      mult_fit_back_without_trans %>% broom::glance()%>% mutate(model_type = "mult_fit_back_without_trans")) %>%
        dplyr::select(model_type, everything())
```


## Assessing Multicollinearity
```{r}
# Calculate the variance inflation factor (VIF)
check_collinearity(mult_fit_back_without)

# Remove the variable whose vif is larger than 10 
mult_fit_back_without_vif = lm(crime_rate ~ pop18 + bagrad + pcincome + region + pcarea + pcbeds, data = cdi_pc_out)
mult_fit_back_without_vif 

# Add the interaction 
mult_fit_back_without_int = lm(crime_rate ~ pop18 + bagrad + pcincome + region + pcarea + pcbeds + poverty + pcincome*poverty + pcincome*bagrad + pop18*bagrad, data = cdi_pc_out)
mult_fit_back_without_int
```

## Compare the Adjusted R^2
```{r}
rbind(mult_fit_back_without %>% broom::glance() %>% mutate(model_type = "mult_fit_back_without"),
      mult_fit_back_without_vif %>% broom::glance() %>% mutate(model_type = "mult_fit_back_without_vif"), 
      mult_fit_back_without_int %>% broom::glance() %>% mutate(model_type = "mult_fit_back_without_int")) %>%
      dplyr::select(model_type, everything())
```






```{r}
set.seed(123)
inTrain <- createDataPartition(y = cdi_pc$crime_rate, p = 0.8, list = FALSE)
str(inTrain)
training <- cdi_pc[inTrain,]
testing <- cdi_pc[-inTrain,]

split <- 0.80
set.seed(1234)
cdi<- cdi %>%
  select(-c(id,cty,state,pop,crimes))
trainIndex <- sample(1:nrow(cdi), 0.8*nrow(cdi))
data_train <- cdi[ trainIndex,]
data_test <- cdi[-trainIndex,]
dim(data_train)
dim(data_test) 
```



```{r}
ctrl <- trainControl(method = "repeatedcv", repeats = 3, classProbs = TRUE, summaryFunction = twoClassSummary)
plsFit <- train(crime_rate~., data = training, method = "pls", tuneLength = 15, trControl = ctrl, metric = "ROC", preProc =  c("center", "scale"))
library(pls)
plsFit

plsClass <- predict(plsFit, newdata = testing)
```








# Validation
```{r}
set.seed(1234)
# Use 5-fold validation and create the training sets
train = trainControl(method = "cv", number = 5)

# Fit the 4-variables model that we discussed in previous lectures
model_caret = train(crime_rate ~ pop18 + bagrad + poverty + 
                    pcincome + region + pcarea + pcbeds,
                    data = cdi_pc_out,
                    trControl = train,
                    method = 'lm',
                    na.action = na.pass)

model_caret = predict(crime_rate ~ pop18 + bagrad + poverty + 
                      pcincome + region + pcarea + pcbeds,
                      data = cdi_pc,
                      trControl = test,
                      method = 'lm',
                      na.action = na.pass)

model_caret$finalModel
model_caret
```



## Validation
```{r}
set.seed(123)
# Use 5-fold validation and create the training sets
train = trainControl(method = "cv", number = 5)

# Fit the 4-variables model that we discussed in previous lectures
model_caret = train(crime_rate ~ pop18 + bagrad + poverty + 
                    pcincome + region + pcarea + pcbeds,
                    data = cdi_new,
                    trControl = train,
                    method = 'lm',
                    na.action = na.pass)

model_caret$finalModel
```






