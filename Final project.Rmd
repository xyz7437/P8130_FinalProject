---
title: "Final Project"
author: "Yijia Jiang"
date: "11/16/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Purpose
We will be analyzing data from the "County Demographic Information" (CDI) data set, which contains characteristics of 440 counties in the United States collected from 1990-1992. The primary objective of this investigation is to develop insight relevant to predicting the crime rate in counties, namely to summarize as the crime rate per 1,000 population (CRM_1000). 


# Import the package we need
```{r include = FALSE}
library(tidyverse)
library(usmap)
library(ggplot2)
library(corrplot)
library(EnvStats)
library(leaps)
library(caret)
library(car)
library(MASS) # boxcox
library(performance) # vif
library(GGally)
```



# Data preprocessing
## Transfer population variables to per capita variables
```{r}
rm(list = ls())
cdi = read.csv("./data/cdi.csv") %>%
  mutate(crime_rate = crimes/pop, 
         pcarea = area/pop,
         pcdocs = docs/pop,
         pcbeds = beds/pop,
         region = relevel(factor(region),ref = 3))
cdi_pc = cdi %>% 
  dplyr::select(crime_rate, everything(), -id, -cty, -state, -area, -docs, -beds, -crimes, -pop, -totalinc)
summary(cdi_pc)
```


# Exploratory Data Analysis
## Rank of the crime rate by state
```{r}
cdi_state <- cdi %>%
  group_by(state) %>%
  summarize(crime_rate = mean(crime_rate))
#cdi_state_rank <- cdi_state[order(-rank(cdi_state$crime_rate)),]

ggplot(cdi_state,aes(x=reorder(state,crime_rate),y=crime_rate,fill=crime_rate)) + 
  geom_bar(stat ='identity')+
  coord_flip() + 
  theme_grey() + 
  labs(title = 'Ranking of Counties by crime rate',
       y='Crime rate',x='Counties') +
  geom_hline(yintercept = mean(cdi$crime_rate),color = "#C9592E")+
  theme(plot.title = element_text(hjust = 0.5,size = 14, face = "bold"),
        axis.text=element_text(size=6.5))
```


## US crime rate map by state
```{r}
p<-plot_usmap(data = cdi_state, values = "crime_rate", color = "#C9592E", size = 0.5,
              labels = TRUE, label_color = "grey10") + 
   scale_fill_continuous(low = "white", high = "#C9592E", na.value = "grey90",
                         name = "Crime rate", label = scales::comma) + 
   theme(legend.position = "right") + 
   theme(panel.background = element_rect(colour = "black")) + 
   labs(title = "US Crime Rate Map") +
   theme(plot.title = element_text(hjust = 0.5,size = 14, face = "bold"))
p$layers[[2]]$aes_params$size <- 2.8
print(p)
```


## Boxplot for each variable
```{r}
par(mfrow=c(3,4))
boxplot(cdi_pc$crime_rate, main = "crime_rate")
boxplot(cdi_pc$pop18, main = "pop18")
boxplot(cdi_pc$pop65, main = "pop65")
boxplot(cdi_pc$pcincome, main = "pcincome")
boxplot(cdi_pc$unemp,main = "unemp")
boxplot(cdi_pc$hsgrad, main = "hsgrad")
boxplot(cdi_pc$bagrad, main = "bagrad")
boxplot(cdi_pc$poverty, main = "poverty")
boxplot(cdi_pc$pcarea, main = "pcarea")
boxplot(cdi_pc$pcdocs, main = "pcdocs")
boxplot(cdi_pc$pcbeds, main = "pcbeds")
boxplot(crime_rate ~ region, data = cdi_pc, main = "region")
```


## Scatterplot Matrix
```{r}
pairs(~crime_rate +.,data=cdi_pc, panel = panel.smooth, upper.panel = NULL, main = "Scatterplot Matrix")
```


## Correlation plot/ Heatmap
```{r}
ggcorr(cdi_pc, label = TRUE, hjust = 0.9, layout.exp = 2, label_size = 3)
```


##
```{r}
# qqplot
qqnorm(cdi_pc$pcbeds, pch = 1, frame = FALSE)
qqline(cdi_pc$pcbed, col = "steelblue", lwd = 2)

qqnorm(cdi_pc$crime_rate, pch = 1, frame = FALSE)
qqline(cdi_pc$crime_rate, col = "steelblue", lwd = 2)


```

According to the Shapiro-Wilk normality test, all the data are normally distributed.


## Detect the outliers
```{r}
rosnerTest(cdi_pc$crime_rate,k = 3)$all.stats
```


# Modelling
## Fit regression using all predictors
```{r}
mult_fit = lm(crime_rate ~ ., data = cdi_pc)
summary(mult_fit)
```

## Backwards Elimination
```{r}
mult_fit_back <- step(mult_fit, direction='backward')
mult_fit_back
```
crime_rate ~ pop18 + bagrad + poverty + pcincome + region + pcarea + pcbeds


# Model Diagnostics
## Create Residuals vs Fitted plot & Normal Q-Q plot & Scale-Location plot & Residuals vs Leverage plot to detect the normality of residuals and outliers
```{r}
par(mfrow=c(2,3))
plot(mult_fit_back)
bc = boxcox(mult_fit_back)
durbinWatsonTest(mult_fit_back)
plot(mult_fit_back, which = 4)
```


## Checking to Outliers and Influential Points
```{r}
# remove influential points
cdi_pc_out = cdi_pc[-c(6,128,412),]

# fit model with and without influential points
mult_fit_back_without = lm(crime_rate ~ pop18 + bagrad + poverty + pcincome + region + pcarea + pcbeds, data = cdi_pc_out)

summary(mult_fit_back); summary(mult_fit_back_without)

# diagnose the model without outliers
par(mfrow=c(2,3))
plot(mult_fit_back_without)
bc_without = boxcox(mult_fit_back_without)
plot(mult_fit_back_without, which = 4)
```

## Box-cox transformation
```{r}
(lambda = bc_without$x[which.max(bc_without$y)])
#mult_fit_back_without_trans = lm(((crime_rate^lambda-1)/lambda) ~ pop18 + bagrad + poverty + pcincome + region + pcarea + pcbeds, data = cdi_pc_out)

mult_fit_back_without_trans = lm(crime_rate^0.5 ~ pop18 + bagrad + poverty + pcincome + region + pcarea + pcbeds, data = cdi_pc_out)


par(mfrow = c(1,2))
plot(mult_fit_back_without_trans, which = 2) 
boxcox(mult_fit_back_without_trans)

par(mfrow = c(2,3))
plot(mult_fit_back_without_trans)
bc_without_trans = boxcox(mult_fit_back_without_trans)
plot(mult_fit_back_without_trans, which = 4)

par(mfrow = c(1,2))
plot(mult_fit_back_without, which = 2)
plot(mult_fit_back_without_trans, which = 2)
```

## Compare the Adjusted R^2
```{r}
rbind(mult_fit_back %>% broom::glance() %>% mutate(model_type = "mult_fit_back"),
      mult_fit_back_without %>% broom::glance() %>% mutate(model_type = "mult_fit_back_without"),
      mult_fit_back_without_trans %>% broom::glance()%>% mutate(model_type = "mult_fit_back_without_trans")) %>%
        dplyr::select(model_type, everything())
```


## Assessing Multicollinearity
```{r}
# Calculate the variance inflation factor (VIF)
check_collinearity(mult_fit_back_without)

# Add the interaction 
mult_fit_back_without_vif = lm(crime_rate ~ pop18 + bagrad + pcincome + region + pcarea + pcbeds + poverty + pcincome*poverty + pcincome*bagrad + pop18*bagrad, data = cdi_pc_out)
mult_fit_back_without_vif 
```

## Compare the Adjusted R^2
```{r}
rbind(mult_fit_back_without %>% broom::glance() %>% mutate(model_type = "mult_fit_back_without"),
      mult_fit_back_without_vif %>% broom::glance() %>% mutate(model_type = "mult_fit_back_without_vif")) %>%
      dplyr::select(model_type, everything())
```





```{r}
### Step 1:  Fit simple linear regressions for all variables,look for the variable with lowest p-value
fit1 = lm(crime_rate ~ pop18, data = cdi_pc)
summary(fit1)
fit2 = lm(crime_rate ~ pop65, data = cdi_pc)
summary(fit2)
fit3 = lm(crime_rate ~ hsgrad, data = cdi_pc)
summary(fit3)
fit4 = lm(crime_rate ~ bagrad, data = cdi_pc)
summary(fit4)
fit5 = lm(crime_rate ~ poverty, data = cdi_pc)
summary(fit5)
fit6 = lm(crime_rate ~ unemp, data = cdi_pc)
summary(fit6)
fit7 = lm(crime_rate ~ pcincome, data = cdi_pc)
summary(fit7)
fit8 = lm(crime_rate ~ pcarea, data = cdi_pc)
summary(fit8)
fit9 = lm(crime_rate ~ pcdocs, data = cdi_pc)
summary(fit9)
fit10 = lm(crime_rate ~ pcbeds, data = cdi_pc)
summary(fit10)
fit11 = lm(crime_rate ~ region, data = cdi_pc)
summary(fit11)

# Enter first the one with the lowest p-value: poverty
forward1 = lm(crime_rate ~ poverty, data = cdi_pc)
summary(forward1)

### Step 2: Enter the one with the lowest p-value in the rest 
fit1 = update(forward1, . ~ . +pop18)
summary(fit1)
fit2 = update(forward1, . ~ . +pop65)
summary(fit2)
fit3 = update(forward1, . ~ . +hsgrad)
summary(fit3)
fit4 = update(forward1, . ~ . +bagrad)
summary(fit4)
fit5 = update(forward1, . ~ . +unemp)
summary(fit5)
fit6 = update(forward1, . ~ . +pcincome)
summary(fit6)
fit7 = update(forward1, . ~ . +pcarea)
summary(fit7)
fit8 = update(forward1, . ~ . +pcdocs)
summary(fit8)
fit9 = update(forward1, . ~ . +pcbeds)
summary(fit9)
fit10 = update(forward1, . ~ . +region)
summary(fit10)

# Enter the one with the lowest p-value: pcdocs
forward2 = update(forward1, . ~ . + pcdocs)
summary(forward2)

### Step 3: Enter the one with the lowest p-value in the rest 
fit1 = update(forward2, . ~ . +pop18)
summary(fit1)
fit2 = update(forward2, . ~ . +pop65)
summary(fit2)
fit3 = update(forward2, . ~ . +hsgrad)
summary(fit3)
fit4 = update(forward2, . ~ . +bagrad)
summary(fit4)
fit5 = update(forward2, . ~ . +unemp)
summary(fit5)
fit6 = update(forward2, . ~ . +pcincome)
summary(fit6)
fit7 = update(forward2, . ~ . +pcarea)
summary(fit7)
fit8 = update(forward2, . ~ . +pcbeds)
summary(fit8)
fit9 = update(forward2, . ~ . +region)
summary(fit9)


# Enter the one with the lowest p-value: region
forward3 = update(forward2, . ~ . + region)
summary(forward3)

### Step 4: Enter the one with the lowest p-value in the rest 
fit1 = update(forward3, . ~ . +pop18)
summary(fit1)
fit2 = update(forward3, . ~ . +pop65)
summary(fit2)
fit3 = update(forward3, . ~ . +hsgrad)
summary(fit3)
fit4 = update(forward3, . ~ . +bagrad)
summary(fit4)
fit5 = update(forward3, . ~ . +unemp)
summary(fit5)
fit6 = update(forward3, . ~ . +pcincome)
summary(fit6)
fit7 = update(forward3, . ~ . +pcarea)
summary(fit7)
fit8 = update(forward3, . ~ . +pcbeds)
summary(fit8)


# Enter the one with the lowest p-value: pcarea
forward4 = update(forward3, . ~ . + pcarea)
summary(forward4)


### Step 5: Enter the one with the lowest p-value in the rest 
fit1 = update(forward4, . ~ . +pop18)
summary(fit1)
fit2 = update(forward4, . ~ . +pop65)
summary(fit2)
fit3 = update(forward4, . ~ . +hsgrad)
summary(fit3)
fit4 = update(forward4, . ~ . +bagrad)
summary(fit4)
fit5 = update(forward4, . ~ . +unemp)
summary(fit5)
fit6 = update(forward4, . ~ . +pcincome)
summary(fit6)
fit7 = update(forward4, . ~ . +pcbeds)
summary(fit7)

# Enter the one with the lowest p-value: pcincome
forward5 = update(forward4, . ~ . + pcincome)
summary(forward5)


### Step 6: Enter the one with the lowest p-value in the rest 
fit1 = update(forward5, . ~ . +pop18)
summary(fit1)
fit2 = update(forward5, . ~ . +pop65)
summary(fit2)
fit3 = update(forward5, . ~ . +hsgrad)
summary(fit3)
fit4 = update(forward5, . ~ . +bagrad)
summary(fit4)
fit5 = update(forward5, . ~ . +unemp)
summary(fit5)
fit6 = update(forward5, . ~ . +pcbeds)
summary(fit6)


# P-value of all new added variables are larger than 0.05, which means that they 
# are not significant predictor, and we stop here.

# The model we obtained is crime_rate ~ poverty + pcdocs + region + pcarea + pcincome
mult_fit_forward = lm(crime_rate ~ poverty + pcdocs + region + pcarea + 
    pcincome, data = cdi_pc)
summary(mult_fit_forward)

```












# Validation
```{r}
set.seed(123)
# Use 5-fold validation and create the training sets
train = trainControl(method = "cv", number = 5)
test = testControl(method = "cv", number = 5)

# Fit the 4-variables model that we discussed in previous lectures
model_caret = train(crime_rate ~ pop18 + bagrad + poverty + 
                    pcincome + region + pcarea + pcbeds,
                    data = cdi_pc,
                    trControl = train,
                    method = 'lm',
                    na.action = na.pass)

model_caret = test(crime_rate ~ pop18 + bagrad + poverty + 
                    pcincome + region + pcarea + pcbeds,
                    data = cdi_pc,
                    trControl = test,
                    method = 'lm',
                    na.action = na.pass)

model_caret$finalModel
model_caret
```



## Validation
```{r}
set.seed(123)
# Use 5-fold validation and create the training sets
train = trainControl(method = "cv", number = 5)

# Fit the 4-variables model that we discussed in previous lectures
model_caret = train(crime_rate ~ pop18 + bagrad + poverty + 
                    pcincome + region + pcarea + pcbeds,
                    data = cdi_new,
                    trControl = train,
                    method = 'lm',
                    na.action = na.pass)

model_caret$finalModel
```






